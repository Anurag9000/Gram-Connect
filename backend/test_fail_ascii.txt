============================= test session starts =============================
platform win32 -- Python 3.10.11, pytest-8.4.2, pluggy-1.6.0
rootdir: D:\Done,Toreview\SocialCode\backend
plugins: anyio-4.11.0, cov-7.0.0, html-4.0.2, metadata-3.1.1, mock-3.15.1, ordering-0.6, rerunfailures-16.1, xdist-3.8.0, seleniumbase-4.44.15
collected 3 items

tests\test_recommender_service.py .FF                                    [100%]

================================== FAILURES ===================================
_________________________ test_enforce_unique_members _________________________

    def test_enforce_unique_members():
        teams = [
            {"team_ids": "p1;p2", "members": [{"person_id": "p1"}, {"person_id": "p2"}], "goodness": 0.8},
            {"team_ids": "p2;p3", "members": [{"person_id": "p2"}, {"person_id": "p3"}], "goodness": 0.7}
        ]
        # p2 is in both, so second team should be modified
        with patch('recommender_service._evaluate_team') as mock_eval:
            mock_eval.return_value = {"score": 0.5, "metrics": {"coverage": 0.5, "k_robustness": 0.5, "redundancy": 0.1, "set_size": 0.1}}
    
>           res = recommender_service._enforce_unique_members(
                teams, ["skill1"], "backend", None, 0.35, 1, 1.0, 1.0, 0.5
            )

tests\test_recommender_service.py:33: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
recommender_service.py:99: in _enforce_unique_members
    "team_names": "; ".join([m["name"] for m in keep_members]),
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

.0 = <list_iterator object at 0x00000210F0245DB0>

>       "team_names": "; ".join([m["name"] for m in keep_members]),
        "team_size": len(keep_members),
        "goodness": round(eval_res["score"], 4),
        "coverage": round(metrics["coverage"], 3),
        "k_robustness": round(metrics["k_robustness"], 3),
        "redundancy": round(metrics["redundancy"], 3),
        "set_size": round(metrics["set_size"], 3),
        "willingness_avg": round(metrics["willingness_avg"], 3) if "willingness_avg" in metrics else updated_team.get("willingness_avg", 0.0),
        "willingness_min": round(metrics["willingness_min"], 3) if "willingness_min" in metrics else updated_team.get("willingness_min", 0.0),
    })
E   KeyError: 'name'

recommender_service.py:99: KeyError
____________________ test_generate_recommendations_fusion _____________________

mock_open = <MagicMock name='open' id='2271772690992'>
mock_pickle = <MagicMock name='load' id='2271772700256'>
mock_embed = <MagicMock name='embed_with' id='2271771650960'>
mock_people = <MagicMock name='read_people' id='2271771534736'>
mock_dist = <MagicMock name='load_distance_lookup' id='2271771528976'>
mock_village = <MagicMock name='load_village_names' id='2271773112304'>

    @patch('recommender_service.load_village_names')
    @patch('recommender_service.load_distance_lookup')
    @patch('recommender_service.read_people')
    @patch('recommender_service.embed_with')
    @patch('pickle.load')
    @patch('builtins.open', create=True)
    def test_generate_recommendations_fusion(mock_open, mock_pickle, mock_embed, mock_people, mock_dist, mock_village):
        # Mock data
        mock_pickle.return_value = {
            "model": MagicMock(),
            "backend": "tfidf",
            "prop_model": MagicMock(),
            "people_model": MagicMock()
        }
        mock_people.return_value = [{"person_id": "p1", "text": "skills", "W": 1.0, "availability": "immediately available"}]
        mock_embed.return_value = [[1.0]] # Sim matrix
    
>       config = RecommendationConfig(
            model="fake.pkl",
            people="people.csv",
            proposal_text="Original text",
            transcription="Transcribed text",
            visual_tags=["Tag1"],
            task_start="2023-01-01T10:00:00",
            task_end="2023-01-01T12:00:00"
        )
E       TypeError: RecommendationConfig.__init__() got an unexpected keyword argument 'transcription'

tests\test_recommender_service.py:58: TypeError
=========================== short test summary info ===========================
FAILED tests/test_recommender_service.py::test_enforce_unique_members - KeyEr...
FAILED tests/test_recommender_service.py::test_generate_recommendations_fusion
========================= 2 failed, 1 passed in 3.40s =========================
